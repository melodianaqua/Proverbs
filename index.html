<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proverbs Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            font-weight: 400;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-group {
            background: #f8f9ff;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .control-group h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: transparent;
        }

        .btn.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: transparent;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: transparent;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e5e7eb 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .progress-container {
            background: #f3f4f6;
            border-radius: 50px;
            height: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 50px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .reading-section {
            background: #f8f9ff;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
        }

        .badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge.completed {
            background: #dcfce7;
            color: #166534;
        }

        .badge.current {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.sectional {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .verse-content {
            font-size: 1.125rem;
            line-height: 1.8;
            color: #374151;
            margin-bottom: 1rem;
        }

        .section-info {
            background: #e0e7ff;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #4338ca;
        }

        .copyright {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .reflection-area {
            background: #f9fafb;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .reflection-area h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .reflection-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.2s ease;
            background: white;
        }

        .reflection-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .navigation-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .select-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .select-input {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s ease;
        }

        .select-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .message {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
            font-weight: 500;
        }

        .message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            opacity: 0.6;
        }

        .mode-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: #6b7280;
        }

        .mode-btn.active {
            background: white;
            color: #374151;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        
        .collapsible-section {
            margin-bottom: 1rem;
        }

        .collapsible-header {
            width: 100%;
            text-align: left;
            background: #f3f4f6;
            border: none;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            background: #e5e7eb;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls-section {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .button-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Proverbs Reader</h1>
            <p>Wisdom literature for daily study and reflection</p>
        </div>

        <div class="main-card">
            <!-- Quick Actions - Most important buttons first -->
            <div class="quick-actions">
                <div class="button-group">
                    <button class="btn primary" onclick="loadNextFromPosition()">Continue Reading</button>
                    <button class="btn success" onclick="markCompleted()">Mark Complete</button>
                </div>
            </div>

            <!-- Message -->
            <div class="message" id="message"></div>

            <!-- Reading Section - Priority content first -->
            <div class="reading-section">
                <div class="section-header">
                    <div class="section-title" id="sectionTitle">Proverbs 1:1</div>
                    <div class="badges" id="badges"></div>
                </div>
                <div class="section-info" id="sectionInfo" style="display: none;"></div>
                <div class="verse-content" id="verseContent">
                    Click "Continue Reading" to begin your daily study...
                </div>
                <div class="copyright" id="copyright"></div>
            </div>

            <!-- Reflection -->
            <div class="reflection-area">
                <h3>Reflections & Learning</h3>
                <textarea 
                    class="reflection-textarea" 
                    id="reflectionText" 
                    placeholder="What insights do you gain from this passage? How might you apply this wisdom in your life?"
                ></textarea>
            </div>

            <!-- All Actions -->
            <div class="all-actions">
                <div class="button-group">
                    <button class="btn primary" onclick="loadNextUnread()">Find Next Unread</button>
                    <button class="btn danger" onclick="markUncompleted()">Mark Uncompleted</button>
                    <button class="btn" onclick="previousVerse()">Previous</button>
                    <button class="btn" onclick="nextVerse()">Next</button>
                </div>
            </div>

            <!-- Collapsible Settings -->
            <div class="collapsible-section">
                <button class="collapsible-header" onclick="toggleCollapsible('settings')">
                    <span>Settings & Navigation</span>
                    <span class="chevron" id="settings-chevron">▼</span>
                </button>
                <div class="collapsible-content" id="settings-content" style="display: none;">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="setReadingMode('verse')">Single Verses</button>
                        <button class="mode-btn" onclick="setReadingMode('section')">Literary Sections</button>
                    </div>

                    <!-- Controls Section -->
                    <div class="controls-section">
                        <div class="control-group">
                            <h3>Translation</h3>
                            <div class="button-group">
                                <button class="btn active" onclick="setTranslation('ESV')">ESV</button>
                                <button class="btn" onclick="setTranslation('NASB')">NASB</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>Reading Position</h3>
                            <p>Currently reading: <strong id="currentPosition">Proverbs 1:1</strong></p>
                            <div class="button-group">
                                <button class="btn warning" onclick="setCurrentPosition()">Set Current Position</button>
                                <button class="btn" onclick="markChapterCompleted()">Mark Chapter Complete</button>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="navigation-section">
                        <div class="select-group">
                            <label>Chapter</label>
                            <select class="select-input" id="chapterSelect"></select>
                        </div>
                        <div class="select-group">
                            <label>Verse</label>
                            <select class="select-input" id="verseSelect"></select>
                        </div>
                        <div class="select-group">
                            <label>Actions</label>
                            <button class="btn" onclick="goToSelectedVerse()">Go to Selection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible Stats -->
            <div class="collapsible-section">
                <button class="collapsible-header" onclick="toggleCollapsible('stats')">
                    <span>Progress & Statistics</span>
                    <span class="chevron" id="stats-chevron">▼</span>
                </button>
                <div class="collapsible-content" id="stats-content" style="display: none;">
                    <!-- Progress Bar -->
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="completedCount">0</div>
                            <div class="stat-label">Completed Verses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedChapters">0</div>
                            <div class="stat-label">Completed Chapters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedSections">0</div>
                            <div class="stat-label">Completed Sections</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="progressPercent">0%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const ESV_API_KEY = "d17d535bb86c9b3a55f904a1ddb28160ce2b2dda";
        const ESV_API_URL = "https://api.esv.org/v3/passage/text/";
        
        const SCRIPTURE_API_KEY = "e5ff65c6fd5e6c51e85d05d7da346738";
        const SCRIPTURE_API_URL = "https://api.scripture.api.bible/v1";
        const NASB_BIBLE_ID = "de4e12af7f28f599-02";

        // Proverbs verse counts and sectional divisions
        const PROVERBS_CHAPTERS = {
            1: 33, 2: 22, 3: 35, 4: 27, 5: 23, 6: 35, 7: 27, 8: 36, 9: 18, 10: 32,
            11: 31, 12: 28, 13: 25, 14: 35, 15: 33, 16: 33, 17: 28, 18: 24, 19: 29, 20: 30,
            21: 31, 22: 29, 23: 35, 24: 34, 25: 28, 26: 28, 27: 27, 28: 28, 29: 27, 30: 33, 31: 31
        };

        // Literary sections based on scholarly analysis
        const PROVERBS_SECTIONS = {
            // Collection I: Prologue - Extended teachings
            "1:1-1:7": { title: "Title and Purpose", type: "introduction" },
            "1:8-1:19": { title: "Lecture 1: Avoid Bad Company", type: "lecture" },
            "1:20-1:33": { title: "Wisdom's First Call", type: "poem" },
            "2:1-2:22": { title: "Lecture 2: Benefits of Wisdom", type: "lecture" },
            "3:1-3:12": { title: "Lecture 3: Trust in the Lord", type: "lecture" },
            "3:13-3:35": { title: "Lecture 4: Blessings of Wisdom", type: "lecture" },
            "4:1-4:9": { title: "Lecture 5: Get Wisdom", type: "lecture" },
            "4:10-4:19": { title: "Lecture 6: Two Ways", type: "lecture" },
            "4:20-4:27": { title: "Lecture 7: Guard Your Heart", type: "lecture" },
            "5:1-5:23": { title: "Lecture 8: Marriage vs Adultery", type: "lecture" },
            "6:1-6:19": { title: "Three Follies to Avoid", type: "appendix" },
            "6:20-6:35": { title: "Lecture 9: Cost of Adultery", type: "lecture" },
            "7:1-7:27": { title: "Lecture 10: The Adulteress", type: "lecture" },
            "8:1-8:36": { title: "Wisdom's Second Call", type: "poem" },
            "9:1-9:18": { title: "Two Banquets", type: "epilogue" },
            
            // Chapters 10-31 mostly individual verses, but some grouped sections
            "22:17-24:22": { title: "Thirty Sayings of the Wise", type: "collection" },
            "24:23-24:34": { title: "Further Sayings of the Wise", type: "collection" },
            "30:1-30:33": { title: "Words of Agur", type: "collection" },
            "31:1-31:9": { title: "Words of Lemuel: The Noble King", type: "collection" },
            "31:10-31:31": { title: "The Excellent Wife", type: "poem" }
        };

        let currentChapter = 1;
        let currentVerse = 1;
        let currentTranslation = 'ESV';
        let readingMode = 'verse'; // 'verse' or 'section'
        let progress = JSON.parse(localStorage.getItem('proverbsProgress') || '{"completed": [], "completedSections": [], "reflections": {}, "currentPosition": {"chapter": 1, "verse": 1}, "completedChapters": []}');
        let isLoading = false;

        // Initialize current position from saved progress
        if (progress.currentPosition) {
            currentChapter = progress.currentPosition.chapter;
            currentVerse = progress.currentPosition.verse;
        }

        // Ensure completedSections exists in progress
        if (!progress.completedSections) {
            progress.completedSections = [];
            saveProgress();
        }

        function setReadingMode(mode) {
            readingMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const modeButtons = document.querySelectorAll('[onclick*="setReadingMode"]');
            modeButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${mode}'`)) {
                    btn.classList.add('active');
                }
            });
            
            loadCurrentContent();
            updateStats();
        }

        function getCurrentSectionKey() {
            // Find which section the current verse belongs to
            const verseKey = `${currentChapter}:${currentVerse}`;
            
            for (const [sectionKey, sectionInfo] of Object.entries(PROVERBS_SECTIONS)) {
                const [startRef, endRef] = sectionKey.split('-');
                const [startChapter, startVerse] = startRef.split(':').map(Number);
                const [endChapter, endVerse] = endRef ? endRef.split(':').map(Number) : [startChapter, startVerse];
                
                if ((currentChapter > startChapter || (currentChapter === startChapter && currentVerse >= startVerse)) &&
                    (currentChapter < endChapter || (currentChapter === endChapter && currentVerse <= endVerse))) {
                    return sectionKey;
                }
            }
            return null;
        }

        async function fetchVerseESV(chapter, verse, endVerse = null) {
            const verseRef = endVerse ? `Proverbs ${chapter}:${verse}-${endVerse}` : `Proverbs ${chapter}:${verse}`;
            
            const params = new URLSearchParams({
                'q': verseRef,
                'include-passage-references': 'false',
                'include-verse-numbers': readingMode === 'section',
                'include-first-verse-numbers': 'false',
                'include-footnotes': 'false',
                'include-footnote-body': 'false',
                'include-headings': 'false',
                'include-short-copyright': 'true'
            });

            const response = await fetch(`${ESV_API_URL}?${params}`, {
                headers: {
                    'Authorization': `Token ${ESV_API_KEY}`
                }
            });

            if (!response.ok) {
                throw new Error(`ESV API Error: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.passages && data.passages.length > 0) {
                return data.passages[0].trim();
            } else {
                throw new Error('No passage found in ESV response');
            }
        }

        async function fetchVerseNASB(chapter, verse, endVerse = null) {
            if (endVerse && endVerse !== verse) {
                // For ranges, fetch each verse individually and combine
                const verses = [];
                for (let v = verse; v <= endVerse; v++) {
                    const chapterStr = chapter.toString().padStart(2, '0');
                    const verseStr = v.toString().padStart(2, '0');
                    const verseId = `PRO.${chapterStr}.${verseStr}`;

                    const response = await fetch(`${SCRIPTURE_API_URL}/bibles/${NASB_BIBLE_ID}/verses/${verseId}?content-type=text&include-notes=false&include-titles=false&include-chapter-numbers=false&include-verse-numbers=${readingMode === 'section'}`, {
                        headers: {
                            'api-key': SCRIPTURE_API_KEY
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && data.data.content) {
                            verses.push(readingMode === 'section' ? `${v} ${data.data.content.trim()}` : data.data.content.trim());
                        }
                    }
                }
                return verses.join(' ');
            } else {
                const chapterStr = chapter.toString().padStart(2, '0');
                const verseStr = verse.toString().padStart(2, '0');
                const verseId = `PRO.${chapterStr}.${verseStr}`;

                const response = await fetch(`${SCRIPTURE_API_URL}/bibles/${NASB_BIBLE_ID}/verses/${verseId}?content-type=text&include-notes=false&include-titles=false&include-chapter-numbers=false&include-verse-numbers=false`, {
                    headers: {
                        'api-key': SCRIPTURE_API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`Scripture API Error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.data && data.data.content) {
                    return data.data.content.trim();
                } else {
                    throw new Error('No content found in Scripture API response');
                }
            }
        }

        async function fetchContent(chapter, verse, endVerse = null) {
            try {
                if (currentTranslation === 'ESV') {
                    return await fetchVerseESV(chapter, verse, endVerse);
                } else if (currentTranslation === 'NASB') {
                    return await fetchVerseNASB(chapter, verse, endVerse);
                }
            } catch (error) {
                console.error('Error fetching content:', error);
                throw error;
            }
        }

        function setTranslation(translation) {
            currentTranslation = translation;
            
            // Find the parent control group and update buttons within it
            const translationButtons = document.querySelectorAll('[onclick*="setTranslation"]');
            translationButtons.forEach(btn => btn.classList.remove('active'));
            
            // Find the clicked button by checking onclick attribute
            translationButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${translation}'`)) {
                    btn.classList.add('active');
                }
            });
            
            loadCurrentContent();
        }

        function init() {
            populateChapterSelect();
            updateCurrentPositionDisplay();
            updateStats();
            loadCurrentContent();
        }

        function populateChapterSelect() {
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '';
            
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Chapter ${i}`;
                chapterSelect.appendChild(option);
            }
            
            chapterSelect.value = currentChapter;
            chapterSelect.addEventListener('change', updateVerseSelect);
            updateVerseSelect();
        }

        function updateVerseSelect() {
            const chapterSelect = document.getElementById('chapterSelect');
            const verseSelect = document.getElementById('verseSelect');
            const chapter = parseInt(chapterSelect.value);
            
            verseSelect.innerHTML = '';
            const verseCount = PROVERBS_CHAPTERS[chapter];
            
            for (let i = 1; i <= verseCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Verse ${i}`;
                verseSelect.appendChild(option);
            }
        }

        function goToSelectedVerse() {
            const chapterSelect = document.getElementById('chapterSelect');
            const verseSelect = document.getElementById('verseSelect');
            
            currentChapter = parseInt(chapterSelect.value);
            currentVerse = parseInt(verseSelect.value);
            
            loadCurrentContent();
        }

        function setCurrentPosition() {
            progress.currentPosition = { chapter: currentChapter, verse: currentVerse };
            saveProgress();
            updateCurrentPositionDisplay();
            showMessage(`Current reading position set to Proverbs ${currentChapter}:${currentVerse}`, 'success');
        }

        function updateCurrentPositionDisplay() {
            const pos = progress.currentPosition || { chapter: 1, verse: 1 };
            document.getElementById('currentPosition').textContent = `Proverbs ${pos.chapter}:${pos.verse}`;
        }

        function markChapterCompleted() {
            const chapter = currentChapter;
            
            // Mark all verses in the chapter as completed
            const verseCount = PROVERBS_CHAPTERS[chapter];
            for (let verse = 1; verse <= verseCount; verse++) {
                const verseKey = getVerseKey(chapter, verse);
                if (!progress.completed.includes(verseKey)) {
                    progress.completed.push(verseKey);
                }
            }
            
            // Mark chapter as completed
            if (!progress.completedChapters.includes(chapter)) {
                progress.completedChapters.push(chapter);
            }
            
            // Mark any sections in this chapter as completed
            for (const sectionKey of Object.keys(PROVERBS_SECTIONS)) {
                const [startRef, endRef] = sectionKey.split('-');
                const [startChapter] = startRef.split(':').map(Number);
                if (startChapter === chapter && !progress.completedSections.includes(sectionKey)) {
                    progress.completedSections.push(sectionKey);
                }
            }
            
            saveProgress();
            loadCurrentContent();
            updateStats();
            
            showMessage(`Marked all content in Proverbs ${chapter} as completed!`, 'success');
        }

        function getVerseKey(chapter, verse) {
            return `${chapter}:${verse}`;
        }

        function getTotalVerses() {
            return Object.values(PROVERBS_CHAPTERS).reduce((sum, count) => sum + count, 0);
        }

        function getTotalSections() {
            return Object.keys(PROVERBS_SECTIONS).length;
        }

        function setLoadingState(loading) {
            isLoading = loading;
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = loading);
            
            if (loading) {
                document.getElementById('verseContent').textContent = `Loading from ${currentTranslation}...`;
                document.getElementById('verseContent').classList.add('loading');
            } else {
                document.getElementById('verseContent').classList.remove('loading');
            }
        }

        async function loadCurrentContent() {
            if (readingMode === 'section') {
                await loadCurrentSection();
            } else {
                await loadCurrentVerse();
            }
        }

        async function loadCurrentSection() {
            const sectionKey = getCurrentSectionKey();
            
            if (!sectionKey) {
                // Fallback to single verse if no section found
                await loadCurrentVerse();
                return;
            }

            const sectionInfo = PROVERBS_SECTIONS[sectionKey];
            const [startRef, endRef] = sectionKey.split('-');
            const [startChapter, startVerse] = startRef.split(':').map(Number);
            const [endChapter, endVerse] = endRef ? endRef.split(':').map(Number) : [startChapter, startVerse];

            const isCompleted = progress.completedSections.includes(sectionKey);
            const isCurrentPosition = progress.currentPosition && 
                progress.currentPosition.chapter === currentChapter && 
                progress.currentPosition.verse === currentVerse;
            
            // Update title and badges
            const sectionTitle = `${sectionInfo.title} (${startRef}${endRef ? `-${endRef}` : ''})`;
            document.getElementById('sectionTitle').textContent = sectionTitle;
            
            let badges = '';
            if (isCompleted) badges += '<span class="badge completed">Completed</span>';
            if (isCurrentPosition) badges += '<span class="badge current">Current Position</span>';
            badges += '<span class="badge sectional">Literary Section</span>';
            document.getElementById('badges').innerHTML = badges;

            // Show section info
            const sectionInfoEl = document.getElementById('sectionInfo');
            sectionInfoEl.style.display = 'block';
            sectionInfoEl.innerHTML = `
                <strong>Section Type:</strong> ${sectionInfo.type}<br>
                <strong>Verses:</strong> ${startRef}${endRef ? ` through ${endRef}` : ''}<br>
                <strong>Literary Unit:</strong> This passage should be read as a complete unit of thought.
            `;
            
            // Load existing reflection
            const reflection = progress.reflections[sectionKey] || '';
            document.getElementById('reflectionText').value = reflection;
            
            // Update selects
            document.getElementById('chapterSelect').value = currentChapter;
            updateVerseSelect();
            document.getElementById('verseSelect').value = currentVerse;
            
            // Fetch section text
            setLoadingState(true);
            
            try {
                const sectionText = await fetchContent(startChapter, startVerse, endChapter === startChapter ? endVerse : null);
                const copyrightText = currentTranslation === 'ESV' ? 
                    'Scripture quotations are from the ESV® Bible' :
                    'Scripture taken from the NASB';
                    
                document.getElementById('verseContent').innerHTML = sectionText;
                document.getElementById('copyright').textContent = copyrightText;
            } catch (error) {
                document.getElementById('verseContent').innerHTML = `
                    <span style="color: #ef4444;">
                        Error loading section: ${error.message}
                        <br><br>
                        Please check your internet connection and try again.
                    </span>
                `;
                showMessage(`Error loading section from ${currentTranslation} API. Please try again.`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        async function loadCurrentVerse() {
            const verseKey = getVerseKey(currentChapter, currentVerse);
            const verseRef = `Proverbs ${verseKey}`;
            const isCompleted = progress.completed.includes(verseKey);
            const isCurrentPosition = progress.currentPosition && 
                progress.currentPosition.chapter === currentChapter && 
                progress.currentPosition.verse === currentVerse;
            
            let badges = '';
            if (isCompleted) badges += '<span class="badge completed">Completed</span>';
            if (isCurrentPosition) badges += '<span class="badge current">Current Position</span>';
            
            document.getElementById('sectionTitle').textContent = `${verseRef} (${currentTranslation})`;
            document.getElementById('badges').innerHTML = badges;
            
            // Hide section info for single verses
            document.getElementById('sectionInfo').style.display = 'none';
            
            // Load existing reflection
            const reflection = progress.reflections[verseKey] || '';
            document.getElementById('reflectionText').value = reflection;
            
            // Update selects
            document.getElementById('chapterSelect').value = currentChapter;
            updateVerseSelect();
            document.getElementById('verseSelect').value = currentVerse;
            
            // Fetch verse text
            setLoadingState(true);
            
            try {
                const verseText = await fetchContent(currentChapter, currentVerse);
                const copyrightText = currentTranslation === 'ESV' ? 
                    'Scripture quotations are from the ESV® Bible' :
                    'Scripture taken from the NASB';
                    
                document.getElementById('verseContent').innerHTML = verseText;
                document.getElementById('copyright').textContent = copyrightText;
            } catch (error) {
                document.getElementById('verseContent').innerHTML = `
                    <span style="color: #ef4444;">
                        Error loading verse: ${error.message}
                        <br><br>
                        Please check your internet connection and try again.
                    </span>
                `;
                showMessage(`Error loading verse from ${currentTranslation} API. Please try again.`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function findNextUnread() {
            if (readingMode === 'section') {
                return findNextUnreadSection();
            } else {
                return findNextUnreadVerse();
            }
        }

        function findNextUnreadVerse() {
            for (let chapter = 1; chapter <= 31; chapter++) {
                const verseCount = PROVERBS_CHAPTERS[chapter];
                for (let verse = 1; verse <= verseCount; verse++) {
                    const verseKey = getVerseKey(chapter, verse);
                    if (!progress.completed.includes(verseKey)) {
                        return { chapter, verse };
                    }
                }
            }
            return null;
        }

        function findNextUnreadSection() {
            // Find next unread section
            for (const sectionKey of Object.keys(PROVERBS_SECTIONS)) {
                if (!progress.completedSections.includes(sectionKey)) {
                    const [startRef] = sectionKey.split('-');
                    const [chapter, verse] = startRef.split(':').map(Number);
                    return { chapter, verse };
                }
            }
            return null;
        }

        function findNextFromPosition() {
            const pos = progress.currentPosition || { chapter: 1, verse: 1 };
            let chapter = pos.chapter;
            let verse = pos.verse;
            
            if (readingMode === 'section') {
                // Find next unread section from current position
                const currentSectionKey = getCurrentSectionKey();
                let foundCurrent = !currentSectionKey;
                
                for (const sectionKey of Object.keys(PROVERBS_SECTIONS)) {
                    if (!foundCurrent && sectionKey === currentSectionKey) {
                        foundCurrent = true;
                        if (!progress.completedSections.includes(sectionKey)) {
                            return { chapter, verse };
                        }
                        continue;
                    }
                    
                    if (foundCurrent && !progress.completedSections.includes(sectionKey)) {
                        const [startRef] = sectionKey.split('-');
                        const [secChapter, secVerse] = startRef.split(':').map(Number);
                        return { chapter: secChapter, verse: secVerse };
                    }
                }
                return null;
            } else {
                // Check if current position is completed, if so find next in sequence
                while (chapter <= 31) {
                    const verseKey = getVerseKey(chapter, verse);
                    if (!progress.completed.includes(verseKey)) {
                        return { chapter, verse };
                    }
                    
                    // Move to next verse
                    if (verse < PROVERBS_CHAPTERS[chapter]) {
                        verse++;
                    } else if (chapter < 31) {
                        chapter++;
                        verse = 1;
                    } else {
                        break;
                    }
                }
                return null;
            }
        }

        async function loadNextFromPosition() {
            if (isLoading) return;
            
            const nextContent = findNextFromPosition();
            if (nextContent) {
                currentChapter = nextContent.chapter;
                currentVerse = nextContent.verse;
                await loadCurrentContent();
                showMessage(`Continuing from position: Proverbs ${currentChapter}:${currentVerse}`, 'success');
            } else {
                showMessage("You've completed all content from your current position!", 'success');
            }
        }

        async function loadNextUnread() {
            if (isLoading) return;
            
            const nextUnread = findNextUnread();
            if (nextUnread) {
                currentChapter = nextUnread.chapter;
                currentVerse = nextUnread.verse;
                await loadCurrentContent();
                showMessage(`Found next unread: Proverbs ${currentChapter}:${currentVerse}`, 'success');
            } else {
                showMessage("Congratulations! You've completed all of Proverbs!", 'success');
            }
        }

        function markCompleted() {
            if (isLoading) return;
            
            const reflection = document.getElementById('reflectionText').value.trim();
            
            if (readingMode === 'section') {
                const sectionKey = getCurrentSectionKey();
                if (sectionKey && !progress.completedSections.includes(sectionKey)) {
                    progress.completedSections.push(sectionKey);
                }
                
                if (reflection) {
                    progress.reflections[sectionKey] = reflection;
                }
                
                showMessage(`Marked section as completed!${reflection ? ' Reflection saved.' : ''}`, 'success');
            } else {
                const verseKey = getVerseKey(currentChapter, currentVerse);
                
                if (!progress.completed.includes(verseKey)) {
                    progress.completed.push(verseKey);
                }
                
                if (reflection) {
                    progress.reflections[verseKey] = reflection;
                }
                
                showMessage(`Marked Proverbs ${currentChapter}:${currentVerse} as completed!${reflection ? ' Reflection saved.' : ''}`, 'success');
            }
            
            saveProgress();
            loadCurrentContent();
            updateStats();
        }

        function markUncompleted() {
            if (isLoading) return;
            
            if (readingMode === 'section') {
                const sectionKey = getCurrentSectionKey();
                if (sectionKey) {
                    const index = progress.completedSections.indexOf(sectionKey);
                    if (index > -1) {
                        progress.completedSections.splice(index, 1);
                    }
                    showMessage(`Marked section as uncompleted.`, 'success');
                }
            } else {
                const verseKey = getVerseKey(currentChapter, currentVerse);
                const index = progress.completed.indexOf(verseKey);
                if (index > -1) {
                    progress.completed.splice(index, 1);
                }
                showMessage(`Marked Proverbs ${currentChapter}:${currentVerse} as uncompleted.`, 'success');
            }
            
            saveProgress();
            loadCurrentContent();
            updateStats();
        }

        async function previousVerse() {
            if (isLoading) return;
            
            if (currentVerse > 1) {
                currentVerse--;
            } else if (currentChapter > 1) {
                currentChapter--;
                currentVerse = PROVERBS_CHAPTERS[currentChapter];
            }
            await loadCurrentContent();
        }

        async function nextVerse() {
            if (isLoading) return;
            
            const maxVerse = PROVERBS_CHAPTERS[currentChapter];
            if (currentVerse < maxVerse) {
                currentVerse++;
            } else if (currentChapter < 31) {
                currentChapter++;
                currentVerse = 1;
            }
            await loadCurrentContent();
        }

        function updateStats() {
            const completed = progress.completed.length;
            const completedChapters = progress.completedChapters.length;
            const completedSections = progress.completedSections.length;
            const total = getTotalVerses();
            const percent = Math.round((completed / total) * 100);
            
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('completedChapters').textContent = completedChapters;
            document.getElementById('completedSections').textContent = completedSections;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        function saveProgress() {
            localStorage.setItem('proverbsProgress', JSON.stringify(progress));
        }

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 4000);
        }

        function toggleCollapsible(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const chevron = document.getElementById(`${sectionId}-chevron`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                content.classList.add('open');
                chevron.classList.add('open');
            } else {
                content.style.display = 'none';
                content.classList.remove('open');
                chevron.classList.remove('open');
            }
        }

        // Initialize the app
        init();
</script>
</body>
</html>
